<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表单动画效果</title>
    <style>
        /* Basic setup and centering for the popup */
        body {
            margin: 0;
            padding: 0;
            background-color: white;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Hide anything that goes off-screen */
        }

        /* The main popup container */
        .popup {
            width: 298px;
            height: 310px;
            position: relative;
            background-image: url('https://km.sankuai.com/api/file/cdn/2714970292/185946730941?contentType=1&isNewContent=false');
            background-size: cover;
            background-repeat: no-repeat;
        }

       
        .diagram-wrapper {
            position: absolute;
            left: 21px;
            top: 37px; /* -137px */
            width: 256px;  /* 宽度保持一致 */
            height: 142px; /* 设置新的高度 */
            border-radius: 6px;
            overflow: hidden;
        }

        .diagram {
            width: 266px;
            height: 150px;
            position: relative;
            left: 0;
            top: -8px;           
            //background-color: #EAEAEA;
            background-image: url(https://km.sankuai.com/api/file/cdn/2714970292/185947265573?contentType=1&isNewContent=false);
            background-size: cover;
            background-repeat: no-repeat;            
            overflow: hidden;
        }

        /* Shared styles for all small form elements */
        .form-piece {
            position: absolute;
            width: 30px;
            height: 40px;
            background-size: contain;
            background-repeat: no-repeat;
            transform-origin: center center;
            /* Hide the original template elements */
            display: none;
        }
        
        /* This class will be added to the generated clones to make them visible */
        .clone {
            display: block;
        }

        /* Specific styles for each element based on requirements */
        .style-empty-form-1 {
            left: 120px;
            top: 120px;
            background-image: url('https://km.sankuai.com/api/file/cdn/2714970292/185935040404?contentType=1&isNewContent=false');
            transform: rotate(-10deg) scale(0.12);
        }

        .style-empty-form-2 {
            left: 130px;
            top: 120px;
            background-image: url('https://km.sankuai.com/api/file/cdn/2714970292/185935040404?contentType=1&isNewContent=false');
            transform: rotate(0deg) scale(0.12);
        }

        .style-full-form-1 {
            left: 250px;
            top: -66px;
            background-image: url('https://km.sankuai.com/api/file/cdn/2714970292/185936478078?contentType=1&isNewContent=false');
            transform: rotate(30deg) scale(1.3);
        }

        .style-full-form-2 {
            left: 190px;
            top: -66px;
            background-image: url('https://km.sankuai.com/api/file/cdn/2714970292/185936478078?contentType=1&isNewContent=false');
            transform: rotate(20deg) scale(1.3);
        }

        .table-graphic {
            position: absolute;
            width: 88px;
            height: 50px;
            left: 89px;
            top: 96px;
            background-image: url('https://km.sankuai.com/api/file/cdn/2714970292/185945198704?contentType=1&isNewContent=false');
            background-size: contain;
            z-index:99;
        }

        .close-icon {
            position: absolute;
            width: 16px;
            height: 16px;
            right: 21px;
            top: 13px;
            background-image: url('https://km.sankuai.com/api/file/cdn/2714970292/185949417138?contentType=1&isNewContent=false');
            background-size: contain;
            cursor: pointer;
        }
        
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.2em;
            color: #555;
        }
    </style>
</head>
<body>

    <div id="preloader">
        <span>图片加载中...</span>
    </div>

    <div class="popup">
        <div class="diagram-wrapper"> 
            <div class="diagram">
                <!-- These are now TEMPLATES for creating the pools -->
                <div id="empty-form-1" class="form-piece style-empty-form-1" data-rotation="-30"></div>
                <div id="empty-form-2" class="form-piece style-empty-form-2" data-rotation="-20"></div>
                <div id="full-form-1" class="form-piece style-full-form-1" data-rotation="30"></div>
                <div id="full-form-2" class="form-piece style-full-form-2" data-rotation="20"></div>
                <div class="table-graphic"></div>
            </div>
        </div>
        <div class="close-icon"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const imageUrls = [
                'https://km.sankuai.com/api/file/cdn/2714970292/185946730941?contentType=1&isNewContent=false',
                'https://km.sankuai.com/api/file/cdn/2714970292/185945198704?contentType=1&isNewContent=false',
                'https://km.sankuai.com/api/file/cdn/2714970292/185935040404?contentType=1&isNewContent=false',
                'https://km.sankuai.com/api/file/cdn/2714970292/185936478078?contentType=1&isNewContent=false',
                'https://km.sankuai.com/api/file/cdn/2714970292/185949417138?contentType=1&isNewContent=false'
            ];

            let imagesLoaded = 0;
            function onAllImagesLoaded() {
                document.getElementById('preloader').style.display = 'none';
                initializePools();
                startAnimations();
            }

            imageUrls.forEach(url => {
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    imagesLoaded++;
                    if (imagesLoaded === imageUrls.length) onAllImagesLoaded();
                };
                img.onerror = () => {
                    console.error(`Failed to load image: ${url}`);
                    imagesLoaded++;
                    if (imagesLoaded === imageUrls.length) onAllImagesLoaded();
                }
            });

            function getRandom(min, max) {
                return Math.random() * (max - min) + min;
            }

            const POOL_SIZE = 10;
            const pools = {};

            const animationConfigs = {
                'empty-form-1': { id: 'empty-form-1', topRange: [-70, -60], leftRange: [-20, -20], scaleRange: [1.2, 1.3], durationRange: [4, 4.1], easing: 'ease-in'  },
                'empty-form-2': { id: 'empty-form-2', topRange: [-70, -60], leftRange: [40, 40], scaleRange: [1.2, 1.3], durationRange: [4, 4.1], easing: 'ease-in'  },
                'full-form-1': { id: 'full-form-1', topRange: [120, 125], leftRange: [110, 110], scaleRange: [0.12, 0.13], durationRange: [4, 4.1], easing: 'ease-out'  },
                'full-form-2': { id: 'full-form-2', topRange: [120, 125], leftRange: [110, 110], scaleRange: [0.12, 0.13], durationRange: [4, 4.1], easing: 'ease-out'  }
            };

            // 1. Create the pools of elements
            function initializePools() {
                for (const key in animationConfigs) {
                    const config = animationConfigs[key];
                    const template = document.getElementById(config.id);
                    if (!template) continue;

                    pools[key] = []; // Create an array for this pool
                    for (let i = 0; i < POOL_SIZE; i++) {
                        const clone = template.cloneNode(true);
                        clone.removeAttribute('id');
                        clone.classList.add('clone'); // Make it visible
                        template.parentElement.appendChild(clone);
                        pools[key].push(clone);
                    }
                }
            }

            // 2. Animate a single element from a pool
            function animateElement(element, config) {
                 // Get computed styles for accurate start position
                const computedStyle = window.getComputedStyle(element);
                const startTransform = computedStyle.transform;

                const duration = getRandom(config.durationRange[0], config.durationRange[1]) * 1000;
                const targetTop = getRandom(config.topRange[0], config.topRange[1]);
                const targetLeft = getRandom(config.leftRange[0], config.leftRange[1]);
                const targetScale = getRandom(config.scaleRange[0], config.scaleRange[1]);
                // const rotation = element.dataset.rotation || 0;
                // const targetTransform = `rotate(${rotation}deg) scale(${targetScale})`;
                // 将它们改成下面的逻辑：
                let startRotation = parseFloat(element.dataset.rotation || 0);
                let endRotation = startRotation; // 默认结束角度等于开始角度

                // 判断是左侧图标 (empty-form) 还是右侧图标 (full-form)
                if (config.id.includes('empty')) {
                    // 左侧图标，角度增加10度（例如 -30度 变为 -20度）
                    endRotation -= 20;
                } else {
                    // 右侧图标，角度减小10度（例如 30度 变为 20度）
                    endRotation -= 20;
                }

                const targetTransform = `rotate(${endRotation}deg) scale(${targetScale})`;
                
                // Animate both transform and position
                element.animate(
                    [
                        { transform: startTransform, top: computedStyle.top, left: computedStyle.left },
                        { transform: targetTransform, top: `${targetTop}px`, left: `${targetLeft}px` }
                    ],
                    {
                        duration: duration,
                        easing: config.easing 
                        // IMPORTANT: No 'fill: forwards'. The element will auto-revert on completion.
                    }
                );
            }

            // 3. Start the staggered animation loop for all pools
            function startAnimations() {
                for (const key in pools) {
                    const pool = pools[key];
                    const config = animationConfigs[key];
                    let currentIndex = 0;

                    setInterval(() => {
                        const elementToAnimate = pool[currentIndex];
                        animateElement(elementToAnimate, config);
                        
                        // Move to the next element in the pool for the next interval
                        currentIndex = (currentIndex + 1) % POOL_SIZE;
                    }, 750);
                }
            }
        });
    </script>
</body>
</html>
